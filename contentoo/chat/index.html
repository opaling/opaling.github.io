<!DOCTYPE html>
<html>
<head>
  <title>Basic AI Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    #chatWindow {
      width: 100%;
      max-width: 600px;
      height: 300px;
      border: 1px solid #ccc;
      overflow-y: auto;
      margin-bottom: 10px;
      padding: 10px;
    }
    #userMessage {
      width: calc(100% - 60px);
      max-width: 540px;
      height: 30px;
    }
    #sendBtn {
      width: 50px;
      height: 34px;
      margin-left: 10px;
    }
    .user {
      color: blue;
      margin: 10px 0;
      white-space: pre-wrap;
    }
    .assistant {
      color: green;
      margin: 10px 0;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<h1>Chat with AI</h1>
<div id="chatWindow"></div>
<input type="text" id="userMessage" placeholder="Type your message here..." />
<button id="sendBtn">Send</button>

<script>
  // Holds the running chat history
  let chatHistory = [];

  // Attach an event to the "Send" button
  document.getElementById('sendBtn').addEventListener('click', sendMessage);

  // Allow pressing Enter to send the message
  document.getElementById('userMessage').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  // Convert plain text with simple Markdown to HTML
  // - Replaces **bold** notation with <strong> tags
  // - Replaces newlines with <br>
  function formatToHtml(text) {
    // Convert **bold** -> <strong>...</strong>
    let html = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

    // Convert newlines to <br>
    html = html.replace(/\n/g, '<br>');

    return html;
  }

  function sendMessage() {
    const userMessageField = document.getElementById('userMessage');
    const message = userMessageField.value.trim();
    if (!message) return;

    // Append user's message to the chat history
    chatHistory.push(`User: ${message}`);
    updateChatWindow();

    // Send the entire chat history to the server
    fetch("https://p5zy3h.lleverage.run/o5txw05x/2.3", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ chatHistory: chatHistory.join("\n") })
    })
    .then(response => response.text())  // The server returns plain text
    .then(data => {
      // 'data' is the server's response as a plain text string
      const assistantResponse = data || "No response.";
      chatHistory.push(`Assistant: ${assistantResponse}`);
      updateChatWindow();
    })
    .catch(error => {
      console.error("Error:", error);
    })
    .finally(() => {
      // Clear the user's input
      userMessageField.value = "";
      userMessageField.focus();
    });
  }

  // Updates the chat window in the browser
  function updateChatWindow() {
    const chatWindow = document.getElementById('chatWindow');
    chatWindow.innerHTML = "";

    chatHistory.forEach(line => {
      const div = document.createElement("div");

      // Format text as HTML (with bold, line breaks, etc.)
      const formattedText = formatToHtml(line);

      if (line.startsWith("User:")) {
        div.className = "user";
      } else {
        div.className = "assistant";
      }

      // Use innerHTML so bold, line breaks, etc. are displayed
      div.innerHTML = formattedText;
      chatWindow.appendChild(div);
    });

    // Scroll to the bottom each time new content is added
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
</script>

</body>
</html>